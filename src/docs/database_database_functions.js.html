<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>JSDoc: Source: database/database_functions.js</title>

        <script src="scripts/prettify/prettify.js"></script>
        <script src="scripts/prettify/lang-css.js"></script>
        <!--[if lt IE 9]>
            <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
        <link
            type="text/css"
            rel="stylesheet"
            href="styles/prettify-tomorrow.css" />
        <link
            type="text/css"
            rel="stylesheet"
            href="styles/jsdoc-default.css" />
    </head>

    <body>
        <div id="main">
            <h1 class="page-title">Source: database/database_functions.js</h1>

            <section>
                <article>
                    <pre class="prettyprint source linenums"><code>const _ = require('lodash');
const knex = require('knex');

/**
 * Cria uma conexão com o banco de dados usando os parametros fornecidos.
 *
 * @param {Object} connection_config
 * Objeto com as configurações de conexão com o banco de dados.
 *
 * @returns {Promise}
 * Promise que retolve para um objeto com a conexão com o banco de dados.
 */
function openConnection(connection_config) {
    return new Promise((resolve) => {
    
        const connection = knex(connection_config);
        resolve(connection);
    });
}

/**
 * Retorna uma função que cria uma tabela no banco de dados com o nome e os parâmetros fornecidos.
 *
 * @param {Object} param
 * Objeto com as informações necessárias para a criação da tabela.
 *
 * @param {string} param.name
 * Nome da tabela que será criada.
 *
 * @param {Object} param.schema
 * Parâmetros para a criação da tabela.
 *
 * @returns {(connection: Object) => Promise}
 * Função que cria a tabela no banco de dados.
 */
function createTable(param) {
    const { name, schema } = param;
    /**
     * Função que cria a tabela no banco de dados se ela ainda não foi criada.
     *
     * @param {Object} connection
     * Objeto com a conexão para o banco de dados.
     *
     * @returns {Promise&lt;Object> | Object}
     * Promise que resolve para um objeto com a conexão com o banco de dados e o nome da tabela utilizada
     * ou objeto com a conexão com o banco de dados e o nome da tabela.
     */
    return function (connection) {
        return connection.schema.hasTable(name).then((has_table) => {
            if (!has_table) {
                return connection.schema
                    .createTable(name, function (table) {
                        _.forEach(_.toPairs(schema), ([column, params]) => {
                            const { type, ...param } = params;
                            table[type](column, ..._.values(param));
                        });
                    })
                    .then(() => {
                        return { connection, name };
                    });
            } else {
                return { connection, name };
            }
        });
    };
}

/**
 * Função que grava os dados no banco de dados.
 *
 * @param {Array} data
 * Array com os dados para inserção no banco de dados.
 *
 * @param {Object} table
 * Objeto com o nome da tabela para inserção dos dados.
 *
 * @returns {(connection: Object) => Promise}
 * Função que recebe um objeto com a conexão com o banco de dados e retorna uma Promise
 * que resolve para um objeto com a conexão o nome da tabela utilizada.
 */
function writeData(data, table) {
    const { name } = table;
    /**
     * Função que insere os dados na tabela especificada no banco de dados.
     *
     * @param {Object} connection
     * Objeto com a conexão para o banco de dados.
     *
     * @returns {Promise}
     * Promise que resolve para um objeto com a conexão com o banco de dados e o nome da tabela utilizada.
     */
    return function (connection) {
        return connection(name)
            .insert(data)
            .then(() => {
                return { connection, name };
            });
    };
}

/**
 * Fecha a conexão com o banco de dados retornando o nome da tabela utilizada.
 *
 * @param {Object} param
 * Objeto com os parametros para fechar a conexão.
 *
 * @param {Object} param.connection
 * Objeto com a conexão com o banco de dados.
 *
 * @param {string} param.name
 * O nome da tabela utilizada.
 *
 * @returns {string}
 * Retorna o nome da tabela utilizada.
 */
function closeConnection(param) {
    const { connection, name } = param;
    connection.destroy();
    return name;
}

module.exports = {
    closeConnection,
    createTable,
    openConnection,
    writeData
};
</code></pre>
                </article>
            </section>
        </div>

        <nav>
            <h2><a href="index.html">Home</a></h2>
            <h3>Global</h3>
            <ul>
                <li><a href="global.html#addValues">addValues</a></li>
                <li><a href="global.html#addValuesIfNeeded">addValuesIfNeeded</a></li>
                <li><a href="global.html#changeValues">changeValues</a></li>
                <li><a href="global.html#changeValuesIfNeeded">changeValuesIfNeeded</a></li>
                <li><a href="global.html#chunkSplit">chunkSplit</a></li>
                <li><a href="global.html#closeConnection">closeConnection</a></li>
                <li><a href="global.html#convertDateIfNeeded">convertDateIfNeeded</a></li>
                <li><a href="global.html#convertSpreadsheets">convertSpreadsheets</a></li>
                <li><a href="global.html#convertToLowercase">convertToLowercase</a></li>
                <li><a href="global.html#convertValues">convertValues</a></li>
                <li><a href="global.html#convertValuesIfNeeded">convertValuesIfNeeded</a></li>
                <li><a href="global.html#converteDate">converteDate</a></li>
                <li><a href="global.html#create">create</a></li>
                <li><a href="global.html#createCluster">createCluster</a></li>
                <li><a href="global.html#createTable">createTable</a></li>
                <li><a href="global.html#database">database</a></li>
                <li>
                    <a href="global.html#differenceInSecondsBetweenDates"
                        >differenceInSecondsBetweenDates</a
                    >
                </li>
                <li><a href="global.html#divideOneByOther">divideOneByOther</a></li>
                <li><a href="global.html#fileExtension">fileExtension</a></li>
                <li><a href="global.html#flattenData">flattenData</a></li>
                <li><a href="global.html#getFileName">getFileName</a></li>
                <li><a href="global.html#mapObject">mapObject</a></li>
                <li><a href="global.html#mapObjectIfNeeded">mapObjectIfNeeded</a></li>
                <li><a href="global.html#multiplyValues">multiplyValues</a></li>
                <li><a href="global.html#normalize">normalize</a></li>
                <li><a href="global.html#openConnection">openConnection</a></li>
                <li><a href="global.html#parseToObject">parseToObject</a></li>
                <li><a href="global.html#read">read</a></li>
                <li><a href="global.html#readFolder">readFolder</a></li>
                <li><a href="global.html#readSpreadsheet">readSpreadsheet</a></li>
                <li><a href="global.html#readSpreadsheets">readSpreadsheets</a></li>
                <li><a href="global.html#recordValue">recordValue</a></li>
                <li><a href="global.html#removeInvalidData">removeInvalidData</a></li>
                <li>
                    <a href="global.html#removeInvalidDataIfNeeded">removeInvalidDataIfNeeded</a>
                </li>
                <li><a href="global.html#removeWhitespace">removeWhitespace</a></li>
                <li><a href="global.html#renameKeys">renameKeys</a></li>
                <li><a href="global.html#renameKeysIfNeeded">renameKeysIfNeeded</a></li>
                <li><a href="global.html#updateStatus">updateStatus</a></li>
                <li><a href="global.html#writeData">writeData</a></li>
            </ul>
        </nav>

        <br class="clear" />

        <footer>
            Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a> on
            Sun Oct 22 2023 10:46:43 GMT-0300 (Horário Padrão de Brasília)
        </footer>

        <script>
            prettyPrint();
        </script>
        <script src="scripts/linenumber.js"></script>
    </body>
</html>
